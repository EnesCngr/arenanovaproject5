@page "/signup"
@layout ArenaNovaProject5.Web.Components.Layout.PublicLayout
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using ArenaNovaProject5.Web.Services
@using MudBlazor

@inject FirebaseAuthService FirebaseAuth
@inject AuthSessionService Session
@inject FirebaseAuthStateProvider AuthState
@inject NavigationManager Nav
@inject FirebaseService FirebaseService
@inject IJSRuntime JS

<PageTitle>Sign Up</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small"
              Class="d-flex justify-center align-center"
              Style="min-height: calc(100vh - 64px); padding-top:24px; padding-bottom:24px;">

    <MudPaper Elevation="10" Class="pa-6" Style="width:100%; border-radius:18px;">
        <div class="mb-4">
            <MudText Typo="Typo.h5" Style="font-weight:700;">Create your parent account</MudText>
            <MudText Typo="Typo.body2" Style="opacity:.75;">
                Register once to access the parental dashboard.
            </MudText>
        </div>

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true" Class="mb-3">
                @Error
            </MudAlert>
        }

        <EditForm Model="@FormModel" OnValidSubmit="@HandleSignup">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="FormModel.FullName"
                          Label="Full name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Required="true"
                          FullWidth="true"
                          Class="mb-3" />

            <MudTextField @bind-Value="FormModel.Email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Required="true"
                          InputType="InputType.Email"
                          FullWidth="true"
                          Class="mb-3" />


            <MudTextField @bind-Value="FormModel.Password"
                          Label="Password"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Required="true"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          FullWidth="true"
                          Class="mb-3" />

            <MudTextField @bind-Value="FormModel.ConfirmPassword"
                          Label="Confirm password"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Required="true"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          FullWidth="true"
                          Class="mb-2" />

            <div class="d-flex justify-space-between align-center mt-3" style="gap:12px;">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Disabled="@IsBusy"
                           OnClick="@TogglePassword">
                    @(_showPassword ? "Hide" : "Show")
                </MudButton>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@IsBusy"
                           Size="Size.Large">
                    @(IsBusy ? "Creating..." : "Create account")
                </MudButton>
            </div>
        </EditForm>

        <MudDivider Class="my-4" />

        <div class="d-flex justify-center align-center" style="gap:10px;">
            <MudText Typo="Typo.body2" Style="opacity:.75;">Already have an account?</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@GoToLogin">
                Sign in
            </MudButton>
        </div>
    </MudPaper>

</MudContainer>

@code {
    private SignupFormModel FormModel { get; set; } = new();
    private string? Error { get; set; }
    private bool IsBusy { get; set; }
    private bool _showPassword = false;

    

    private void TogglePassword()
    {
        _showPassword = !_showPassword;
    }

    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }

    private async Task HandleSignup()
    {
        Error = null;
        IsBusy = true;

        try
        {
            await JS.InvokeVoidAsync("console.log", "Starting registration...");

            if (FormModel.Password != FormModel.ConfirmPassword)
            {
                Error = "Passwords do not match.";
                return;
            }

            if (FormModel.Password.Length < 6)
            {
                Error = "Password must be at least 6 characters long.";
                return;
            }

            await JS.InvokeVoidAsync("console.log", $"Creating user: {FormModel.Email}");

            // Create Firebase Auth account
            var result = await FirebaseAuth.SignUpAsync(FormModel.Email, FormModel.Password);
            
            if (result == null || string.IsNullOrEmpty(result.LocalId))
            {
                Error = "Registration failed. Please try again.";
                await JS.InvokeVoidAsync("console.error", "Auth failed");
                return;
            }

            await JS.InvokeVoidAsync("console.log", $"Auth successful! UID: {result.LocalId}");

            // Sign in through JavaScript SDK for Firestore access
            await JS.InvokeVoidAsync("console.log", "Signing in through JavaScript SDK...");
            try
            {
                await FirebaseService.SignInAsync(FormModel.Email, FormModel.Password);
                await JS.InvokeVoidAsync("console.log", "JavaScript SDK sign-in successful");
            }
            catch (Exception jsEx)
            {
                Error = $"Account created but JavaScript sign-in failed: {jsEx.Message}";
                await JS.InvokeVoidAsync("console.error", $"JS SDK sign-in error: {jsEx.Message}");
                return;
            }

            // Save user data to Firestore
            var userData = new{
                uid = result.LocalId,
                email = result.Email,
                fullName = FormModel.FullName,
                role = "parent",
                createdAt = DateTime.UtcNow.ToString("o")
            };

            await JS.InvokeVoidAsync("console.log", "Saving to Firestore...");

            var firestoreResult = await FirebaseService.SetDocumentAsync("users", result.LocalId, userData);

            if (!firestoreResult.Success)
            {
                Error = $"Auth created but Firestore failed: {firestoreResult.Error}";
                await JS.InvokeVoidAsync("console.error", $"Firestore error: {firestoreResult.Error}");
                return;
            }

            await JS.InvokeVoidAsync("console.log", $"Registration Successful! Welcome, {FormModel.FullName}!");

            // Set session and navigate
            Session.SetSession(result.IdToken, result.RefreshToken, result.Email, result.LocalId);
            Nav.NavigateTo("/dashboard", forceLoad: true);
        }
        catch (Exception ex)
        {
            Error = $"Error: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Exception: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    public class SignupFormModel
    {
        [Required(ErrorMessage = "Full name is required")]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}

