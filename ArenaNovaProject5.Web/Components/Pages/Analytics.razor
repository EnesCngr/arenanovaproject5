@page "/analytics"
@using MudBlazor
@using System.Text.Json
@inject ArenaNovaProject5.Web.Services.KidSessionService KidSession
@inject HttpClient HttpClient
@inject ArenaNovaProject5.Web.Services.AuthSessionService AuthSessionService

<MudContainer MaxWidth="MaxWidth.Large" Class="page-root">
    <MudText Typo="Typo.h4">Memory Tree</MudText>
    <MudText Typo="Typo.body2" Class="muted">Game analysis and statistics</MudText>

    <div class="spacer"></div>

    @if (string.IsNullOrEmpty(KidSession.ActiveChildIdString))
    {
        <MudAlert Severity="Severity.Info">
            <MudText>No kid selected. Please select a kid from the Kid Panel to view progress.</MudText>
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            <!-- Memory Tree Chart -->
            <MudItem xs="12" md="8">
                <MudCard Class="card">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Memory Tree Progress</MudText>
                        <MudText Typo="Typo.body2" Class="muted">Session performance tracking</MudText>

                        <div class="spacer"></div>

                        @if (RenzoChartData != null && RenzoChartData.Any())
                        {
                            <MudChart ChartType="ChartType.Line"
                                      ChartSeries="@renzoChartSeries"
                                      XAxisLabels="@renzoXLabels"
                                      ChartOptions="@renzoChartOptions"
                                      Height="300px" />
                        }
                        else
                        {
                            <MudText>Game has not been played yet</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Stats Sidebar -->
            <MudItem xs="12" md="4">
                <MudCard Class="card">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Statistics</MudText>
                        <MudText Typo="Typo.body2" Class="muted">Memory Tree metrics</MudText>

                        <div class="spacer"></div>

                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="padding: 12px; background-color: #f5f5f5; border-radius: 4px;">
                                <MudText Typo="Typo.caption" Style="opacity: 0.75;">Highest Score</MudText>
                                <MudText Typo="Typo.h6" Style="font-weight: 700;">@HighestScore</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6;">points</MudText>
                            </div>

                            <div style="padding: 12px; background-color: #f5f5f5; border-radius: 4px;">
                                <MudText Typo="Typo.caption" Style="opacity: 0.75;">Average Score</MudText>
                                <MudText Typo="Typo.h6" Style="font-weight: 700;">@AverageScore</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6;">points</MudText>
                            </div>

                            <div style="padding: 12px; background-color: #f5f5f5; border-radius: 4px;">
                                <MudText Typo="Typo.caption" Style="opacity: 0.75;">Total Sessions</MudText>
                                <MudText Typo="Typo.h6" Style="font-weight: 700;">@TotalSessions</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6;">games played</MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private List<double> RenzoChartData = new();
    private List<ChartSeries> renzoChartSeries = new();
    private string[] renzoXLabels = Array.Empty<string>();
    private ChartOptions renzoChartOptions = new();

    private double HighestScore = 0;
    private double AverageScore = 0;
    private int TotalSessions = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadRenzoData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) return;
        await LoadRenzoData();
    }

    private async Task LoadRenzoData()
    {
        try
        {
            var kidId = KidSession.ActiveChildIdString;
            if (string.IsNullOrEmpty(kidId)) return;

            var token = AuthSessionService.IdToken;
            if (string.IsNullOrEmpty(token)) return;

            var docPath = $"projects/project5-arenanova/databases/(default)/documents/childaccounts/{kidId}/renzoprogress";
            var response = await HttpClient.GetAsync($"https://firestore.googleapis.com/v1/{docPath}?pageSize=500&key=AIzaSyBnGZdvJWAUfXr4ksf7mCJxhVMxL0gXQqk");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Firestore request failed: {response.StatusCode}");
                return;
            }

            var jsonContent = await response.Content.ReadAsStringAsync();
            using var doc = JsonDocument.Parse(jsonContent);
            var root = doc.RootElement;

            if (!root.TryGetProperty("documents", out var documentsArray))
            {
                // No documents found
                RenzoChartData.Clear();
                TotalSessions = 0;
                HighestScore = 0;
                AverageScore = 0;
                renzoChartSeries.Clear();
                renzoXLabels = Array.Empty<string>();
                StateHasChanged();
                return;
            }

            RenzoChartData.Clear();
            var sessionCount = 0;

            foreach (var docElement in documentsArray.EnumerateArray())
            {
                if (docElement.TryGetProperty("fields", out var fields))
                {
                    // Extract rprogress value
                    if (fields.TryGetProperty("rprogress", out var rprogressValue))
                    {
                        if (rprogressValue.TryGetProperty("doubleValue", out var doubleVal))
                        {
                            var value = doubleVal.GetDouble();
                            RenzoChartData.Add(value);
                            sessionCount++;
                        }
                    }
                }
            }

            TotalSessions = sessionCount;

            if (RenzoChartData.Count > 0)
            {
                HighestScore = RenzoChartData.Max();
                AverageScore = Math.Round(RenzoChartData.Sum() / RenzoChartData.Count, 2);
            }
            else
            {
                HighestScore = 0;
                AverageScore = 0;
            }

            // Build chart series and labels
            renzoXLabels = Enumerable.Range(1, RenzoChartData.Count).Select(i => $"S{i}").ToArray();
            renzoChartSeries = new()
            {
                new ChartSeries { Name = "Time", Data = RenzoChartData.ToArray() }
            };

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Renzo data: {ex.Message}");
        }
    }
}
