@page "/analytics"
@using MudBlazor
@using System.Text.Json
@inject ArenaNovaProject5.Web.Services.KidSessionService KidSession
@inject HttpClient HttpClient
@inject ArenaNovaProject5.Web.Services.AuthSessionService AuthSessionService

<MudContainer MaxWidth="MaxWidth.Large" Class="page-root">
    <MudText Typo="Typo.h4">Memory Tree</MudText>
    <MudText Typo="Typo.body2" Class="muted">Game analysis and statistics</MudText>

    <div class="spacer"></div>

    @if (string.IsNullOrEmpty(KidSession.ActiveChildIdString))
    {
        <MudAlert Severity="Severity.Info">
            <MudText>No kid selected. Please select a kid from the Kid Panel to view progress.</MudText>
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            <!-- Memory Tree Chart -->
            <MudItem xs="12" md="8">
                <MudCard Class="card">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Memory Tree Progress</MudText>
                        <MudText Typo="Typo.body2" Class="muted">Session performance tracking</MudText>

                        <div class="spacer"></div>

                        @if (RenzoChartData != null && RenzoChartData.Any())
                        {
                            <MudChart ChartType="ChartType.Line"
                                      ChartSeries="@renzoChartSeries"
                                      XAxisLabels="@renzoXLabels"
                                      ChartOptions="@renzoChartOptions"
                                      Height="300px" />
                        }
                        else
                        {
                            <MudText>Game has not been played yet</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Stats Sidebar -->
            <MudItem xs="12" md="4">
                <MudCard Class="card">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Statistics</MudText>
                        <MudText Typo="Typo.body2" Class="muted">Memory Tree metrics</MudText>

                        <div class="spacer"></div>

                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="padding: 12px; background-color: #f5f5f5; border-radius: 4px;">
                                <MudText Typo="Typo.caption" Style="opacity: 0.75;">Total Sessions</MudText>
                                <MudText Typo="Typo.h6" Style="font-weight: 700;">@TotalSessions</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6;">games played</MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private List<double> RenzoChartData = new();
    private List<ChartSeries> renzoChartSeries = new();
    private string[] renzoXLabels = Array.Empty<string>();
    private ChartOptions renzoChartOptions = new();

    private int TotalSessions = 0;
    
    private string? LastLoadedKidId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadRenzoData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) return;
        
        // Only reload if kid ID changed
        var currentKidId = KidSession.ActiveChildIdString;
        if (currentKidId != LastLoadedKidId)
        {
            await LoadRenzoData();
        }
    }

    private async Task LoadRenzoData()
    {
        try
        {
            var kidId = KidSession.ActiveChildIdString;
            if (string.IsNullOrEmpty(kidId)) return;

            var token = AuthSessionService.IdToken;
            if (string.IsNullOrEmpty(token)) return;

            LastLoadedKidId = kidId;
            
            var projectId = "project5-arenanova";
            var renzoUrl = $"https://firestore.googleapis.com/v1/projects/{projectId}/databases/(default)/documents/childaccounts/{kidId}/renzoprogress?pageSize=1000";
            
            var request = new HttpRequestMessage(HttpMethod.Get, renzoUrl);
            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await HttpClient.SendAsync(request);

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Firestore request failed: {response.StatusCode}");
                return;
            }

            var jsonContent = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Renzo response: {jsonContent.Substring(0, Math.Min(500, jsonContent.Length))}");
            using var doc = JsonDocument.Parse(jsonContent);
            var root = doc.RootElement;

            if (!root.TryGetProperty("documents", out var documentsArray))
            {
                Console.WriteLine("No 'documents' property found in Renzo response");
                // No documents found
                RenzoChartData.Clear();
                TotalSessions = 0;
                renzoChartSeries.Clear();
                renzoXLabels = Array.Empty<string>();
                StateHasChanged();
                return;
            }

            RenzoChartData.Clear();
            var sessionCount = 0;

            foreach (var docElement in documentsArray.EnumerateArray())
            {
                if (docElement.TryGetProperty("fields", out var fields))
                {
                    // Extract rprogress value
                    if (fields.TryGetProperty("rprogress", out var rprogressValue))
                    {
                        double value = 0;
                        bool found = false;
                        
                        // Try doubleValue first
                        if (rprogressValue.TryGetProperty("doubleValue", out var doubleVal))
                        {
                            value = doubleVal.GetDouble();
                            found = true;
                        }
                        // Try integerValue if double not found
                        else if (rprogressValue.TryGetProperty("integerValue", out var intVal))
                        {
                            if (double.TryParse(intVal.GetString() ?? "0", out var parsedValue))
                            {
                                value = parsedValue;
                                found = true;
                            }
                        }
                        
                        if (found)
                        {
                            RenzoChartData.Add(value);
                            sessionCount++;
                            Console.WriteLine($"Renzo session {sessionCount}: rprogress = {value}");
                        }
                    }
                }
            }

            Console.WriteLine($"Total Renzo sessions loaded: {sessionCount}");
            TotalSessions = sessionCount;

            // Build chart series and labels
            renzoXLabels = Enumerable.Range(1, RenzoChartData.Count).Select(i => $"S{i}").ToArray();
            renzoChartSeries = new()
            {
                new ChartSeries { Name = "Time", Data = RenzoChartData.ToArray() }
            };

            // Set Y-axis limits from -5 to 5
            renzoChartOptions = new ChartOptions
            {
                YAxisTicks = 5,
                LineStrokeWidth = 2
            };

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Renzo data: {ex.Message}");
        }
    }
}
